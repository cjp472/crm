/////**// * @author:nk// * @class EquipmentView// * @extends Ext.Panel// * @description 设备管理列表// * @company 科技有限公司// * @createtime:2014-4-1// */var store ;MachineSelfView = Ext.extend(Ext.Panel, {	// 条件搜索Panel	searchPanel : null,	// 数据展示Panel	gridPanel : null,	// GridPanel的数据Store	store : null,	// 头部工具栏	//topbar : null,	// 构造函数	constructor : function(_cfg) {				Ext.applyIf(this, _cfg);		// 初始化组件		this.initUIComponents();		// 调用父类构造		MachineSelfView.superclass.constructor.call(this, {					id : 'MachineSelfView',					title : '自助终端业务信息',					//iconCls : 'menu-role',					region : 'center',					layout : 'border',					items : [this.searchPanel, this.gridPanel]				});	},// end of constructor	// 初始化组件	initUIComponents : function() {				this.store=new Ext.data.SimpleStore({						url : __ctxPath + "/customer/machineListConHis.do",            //url:__ctxPath + '/xitong/listEquipment.do',            autoLoad : true,          	// roleId : -1,          	root : 'result',		  	totalProperty : 'totalCounts',		  	fields:[ "msid","wdNum",			        "wdName","tellernum",			        "bustype","tradedate",			        "dealnum","traderesult",			        "cusName","certigier",			        "cardnum","idcardnum",			        "presentID","parentID",			        "busDealNum","amount"]				    });		 				// 初始化搜索条件Panel		this.searchPanel = new Ext.FormPanel({			height : 35,			region : 'north',			frame : false,			layoutConfig : {				padding : '5',				align : 'middle'			},			id : 'MachineSelfViewSearchForm',			layout : 'hbox',			defaults : {				xtype : 'label',				border : false,				margins : {					top : 2,					right : 4,					bottom : 2,					left : 4				}			},			items : [{	            text : '网点号'	        }, {	        	id:'new_wdNum',	        	dataIndex : 'wdNum',	            name : 'Q_wdNum_S_LK',	            xtype : 'textfield'	        },{	            text : '客户姓名'	        }, {	        	id:'new_cusName',	        	dataIndex : 'cusName',	            name : 'Q_cusName_S_LK',	            xtype : 'textfield'	        },{	            text : '柜员号'	        }, {	        	id:'new_tellernum',	        	dataIndex : 'tellernum',	            name : 'Q_tellernum_S_LK',	            xtype : 'textfield'	        },{	            text : '交易结果'	        }, {	        	id:'new_traderesult',	        	dataIndex : 'traderesult',	        	name : 'new_traderesult',				xtype:'textfield'  //new_traderesult			   	        },{	            text : '开始日期'	        }, {	        	id:'tradedate_start_day',	        	name : 'tradedate_start_day',				xtype:'datetimefield',			    width : '100',				format:'Y-m-d'	        },{	            text : '结束日期'	        }, {	        	id:'tradedate_end_day',	        	name : 'tradedate_end_day',				xtype:'datetimefield',  //new_traderesult			    width : '100',				format:'Y-m-d'	        },{				xtype : 'button',	        	text : '查询',				iconCls : 'search',				scope:this,				handler:function(){					var new_wdNum = Ext.getCmp('new_wdNum').getValue();					var cusname = Ext.getCmp('new_cusName').getValue();					var tellernum = Ext.getCmp('new_tellernum').getValue();					var tradedateS = Ext.get('tradedate_start_day').getValue();					var tradedateE = Ext.get('tradedate_end_day').getValue();					var tradeResult = Ext.getCmp('new_traderesult').getValue();					                              					//alert(tradeResult);					//alert(dealnum+"1-"+cusname+"-"+certigier+"-"+tradedateE+"-"+traderesult);					//通过监听重新刷新数据，在分页实现的查询的时候，为了防止第二遍查询的时候条件丢失，借用监听					this.gridPanel.getStore().addListener({						beforeload:function(store,records,options){							store.baseParams = {									wdNum:new_wdNum,									cusName:cusname,									tellernum:tellernum,									tradedateStart:tradedateS,									tradedateEnd:tradedateE,									traderesult:tradeResult							};						}					});					this.gridPanel.getStore().reload({				    	params: {				    		start:0,				    		limit:25			    	    }		   			 });			 		}			},{			xtype : 'button',			text : __reset,			scope : this,			iconCls : 'btn-reset',			handler : function() {				var searchPanel = Ext.getCmp('MachineSelfViewSearchForm');				searchPanel.getForm().reset();//清除SearchForm的值			}		}]										});// end of the searchPanel		var ss = "#,#" ;		var count = 0;		var sm = new Ext.grid.CheckboxSelectionModel(			/*{				listeners:{					"rowdeselect": function (grid, rowIndex, e) {						if(count == "1" || count == 1){							this.selectRow(rowIndex, false);						}else{							this.selectRow(rowIndex, true);						}					}				}			}*/		);		var cm = new Ext.grid.ColumnModel({			//columns : [{			columns : [new Ext.grid.RowNumberer(), sm, {				header : 'msid',				dataIndex : 'msid',				id : 'msid',				hidden : true			}, {				header : "网点号",				dataIndex : 'wdNum',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "网点名称",				dataIndex : 'wdName',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "柜员号",				dataIndex : 'tellernum',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "业务类型",				dataIndex : 'bustype',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : '交易时间',				isExp : false,				sortable : true,				width :50,				dataIndex : 'tradedate',				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "交易流水号",				dataIndex : 'dealnum',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "业务流水号",				dataIndex : 'busDealNum',				id:'busDealNum',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			},{				header : "交易结果",				dataIndex : 'traderesult',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "客户姓名",				dataIndex : 'cusName',				id:'cusName',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "授权人",				dataIndex : 'certigier',				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "卡号",				dataIndex : 'cardnum',				hidden : true,				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "证件号",				dataIndex : 'idcardnum',				hidden : true,				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			}, {				header : "交易金额",				dataIndex : 'amount',				hidden : false,				width :50,				renderer : function(value) {					if(value == "null"){						return "";					}else{						return value;					}				}			},{				header : "当前网点ID",				dataIndex : 'presentID',				hidden : true,				width :50			}, {				header : "父节点网点ID",				dataIndex : 'parentID',				hidden : true,				width :50			}			]		});// end of cm						this.topbar = new Ext.Toolbar({			items : ['->','->',{			              text : '统计金额',			              hidden : false			           }, {			        	id:'CountAmount',			            name : 'CountAmount',			            xtype : 'textfield',			            readOnly : true,			            hidden : false			          },{						xtype : 'button',			        	text : '统计',						iconCls : 'search',						scope:this,						handler : function(){			        	    var wdNum = Ext.getCmp('new_wdNum').getValue();							var cusname = Ext.getCmp('new_cusName').getValue();							var tellernum = Ext.getCmp('new_tellernum').getValue();			        	  	var tradedateS = Ext.get('tradedate_start_day').getValue();							var tradedateE = Ext.get('tradedate_end_day').getValue();							var tradeResult = Ext.getCmp('new_traderesult').getValue();							//alert(tradedateS+"\n"+tradedateE+"tradeResult"+tradeResult);							if((tradedateS != "" && tradedateE == "") || (tradedateS == "" && tradedateE != "")){								//alert("开始/结束日期必须选择同时选择或同时为空!");								Ext.Msg.alert('温馨提示', '开始/结束日期必须同时选择或同时为空!');							}else{								Ext.Ajax.request({									url : __ctxPath + '/customer/CountMoneyConHis.do',									params : {									  StartT : tradedateS,									  EndT : tradedateE,									  wdNum:wdNum,									  cusname:cusname,									  tellernum:tellernum,									  tradeResult:tradeResult									},									method : 'post',									async: false,									waitMsg : '正在提交数据...',									success : function(result, request) {										 var str1=result.responseText.split(':')[1].split('}')[0];										 Ext.getCmp('CountAmount').setValue(str1);									}								});							}			          	}					}, {						iconCls : 'btn-add',						text : '导出报表 ',						//hidden : true,						xtype : 'button',						scope : this,						handler : function (){				          var strs =Ext.getCmp('new_wdNum').getValue()+"~"				                    +Ext.getCmp('new_cusName').getValue()+"~"				                    +Ext.getCmp('new_tellernum').getValue()+"~"				                    +Ext.get('tradedate_start_day').getValue()+"~"				                    +Ext.get('tradedate_end_day').getValue()+"~"				                    +Ext.getCmp('new_traderesult').getValue();		                   if(strs!=""){					        	 window.open('http://localhost:8090/s2sh_pro/MachineSelf.jsp?day='+strs+'*MachineSelfReport');		                     }else{		                	     //alert("条件不存在！请选择您所需的条件。。。。");		                    	 window.open('http://localhost:8090/s2sh_pro/MachineSelf.jsp?day='+strs+'*MachineSelfReport');		                     }				        																					 						}					}]		});				this.gridPanel = new Ext.grid.GridPanel({			id : 'MachineSelfGrid',			region : 'center',			tbar : this.topbar,			store : this.store,			trackMouseOver : true,			disableSelection : false,			loadMask : true,			// fbar : this.footbar(),			cm : cm,			sm : sm,			// customize view config			viewConfig : {				forceFit : true,				enableRowBody : false,				showPreview : false			},			// paging bar on the bottom			bbar : new HT.PagingBar({store : this.store}),			listeners:{			       rowdblclick : function(grid,row){   			           grid.getSelectionModel().each(function(rec){    				     		//alert(rec.get('msid')); 				     		var tabs = Ext.getCmp('centerTabPanel');							var aForm = Ext.getCmp('MachineSelfFormWin');							if (aForm != null||aForm != undefined) {								tabs.remove(aForm);							}							machineSelfId = rec.get('msid');							busDealNum = rec.get('busDealNum');							aForm = new MachineSelfForm({									});							tabs.add(aForm);							tabs.activate(aForm);													});			       },			       rowclick : function(grid, rowindex, e){//			    	   for(var i=0;i<=ss.split(',').length;i++){//			    		   if(ss.split(',')[i] == rowindex){//			    			   count = 1; //表示点击了已经选中的数据//			    			   break;//			    		   }else{//			    			   count = 0; //表示点击了已经选中的数据//			    		   }//			    	   }//			    	   ss = ss + "," + rowindex;			       }			   }		});					}// end of the initUIComponents//	editRs : function(record) {//		//		var tabs = Ext.getCmp('centerTabPanel');////		var aForm = Ext.getCmp('ConHisFormWin');//          // alert(aForm);//		if (aForm != null||aForm != undefined) {//			tabs.remove(aForm);//		}////		aForm = new ConHisForm({//					conHisId : record.data.conHisId,//					flag:flag//				});////		tabs.add(aForm);////		tabs.activate(aForm);////	}});	